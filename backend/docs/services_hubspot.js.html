<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/hubspot.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/hubspot.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const axios = require('axios');
const qs = require('qs');
const { getToken, saveToken } = require('../db/tokens');

/**
 * Holt die HubSpot-Portal-ID anhand des neuen Access Tokens
 */
const fetchHubspotHubId = async (accessToken) => {
  try {
    const res = await axios.get(`https://api.hubapi.com/oauth/v1/access-tokens/${accessToken}`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });

    return res.data.hub_id;
  } catch (err) {
    console.error('‚ùå Fehler beim Abrufen der hub_id:', err.response?.data || err.message);
    throw err;
  }
};

/**
 * Frischt den Access Token mit dem Refresh Token auf ‚Äì speichert neuen Token
 * @param {string} userIdentifier z.‚ÄØB. "cust001"
 */
const refreshAccessToken = async (userIdentifier, refreshToken) => {
  try {
    const data = qs.stringify({
      grant_type: 'refresh_token',
      client_id: process.env.HUBSPOT_CLIENT_ID,
      client_secret: process.env.HUBSPOT_CLIENT_SECRET,
      refresh_token: refreshToken,
    });

    const response = await axios.post('https://api.hubapi.com/oauth/v1/token', data, {
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
    });

    const tokenData = response.data;

    await saveToken({
      userId: userIdentifier, // wichtig: userIdentifier, wird intern in user_id gemappt
      service: 'hubspot',
      accessToken: tokenData.access_token,
      refreshToken,
      expiresIn: tokenData.expires_in,
    });

    console.log(`üîÅ Access Token f√ºr ${userIdentifier || 'anonymous'} wurde erneuert`);
    return tokenData.access_token;
  } catch (err) {
    console.error('‚ùå Fehler beim Token-Refresh:', err.response?.data || err.message);
    throw err;
  }
};

/**
 * F√ºhrt einen API-Call mit g√ºltigem Token durch, versucht bei 401 Refresh
 */
const callHubspotApi = async ({ userId = null, service = 'hubspot', method = 'GET', endpoint, data = null }) => {
  let token = await getToken(userId, service);
  if (!token) throw new Error(`Kein g√ºltiger Token f√ºr ${service} gefunden`);

  try {
    const response = await axios({
      method,
      url: `https://api.hubapi.com${endpoint}`,
      headers: {
        Authorization: `Bearer ${token.access_token}`,
        'Content-Type': 'application/json',
      },
      data,
    });

    return response.data;
  } catch (err) {
    if (err.response?.status === 401 &amp;&amp; token.refresh_token) {
      console.warn(`‚ö†Ô∏è Token abgelaufen f√ºr ${userId || 'anonymous'} ‚Äì versuche Refresh...`);
      const newAccessToken = await refreshAccessToken(userId, token.refresh_token);

      const retryResponse = await axios({
        method,
        url: `https://api.hubapi.com${endpoint}`,
        headers: {
          Authorization: `Bearer ${newAccessToken}`,
          'Content-Type': 'application/json',
        },
        data,
      });

      return retryResponse.data;
    }

    console.error('‚ùå Fehler beim HubSpot-API-Call:', err.response?.data || err.message);
    throw err;
  }
};

module.exports = {
  callHubspotApi,
  refreshAccessToken,
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#PORT">PORT</a></li><li><a href="global.html#callHubspotApi">callHubspotApi</a></li><li><a href="global.html#ensureOrgExists">ensureOrgExists</a></li><li><a href="global.html#ensureUserExists">ensureUserExists</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#fetchHubspotHubId">fetchHubspotHubId</a></li><li><a href="global.html#getToken">getToken</a></li><li><a href="global.html#hubspotRoutes">hubspotRoutes</a></li><li><a href="global.html#oauthRoutes">oauthRoutes</a></li><li><a href="global.html#refreshAccessToken">refreshAccessToken</a></li><li><a href="global.html#saveToken">saveToken</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sun Jul 20 2025 11:28:52 GMT+0200 (Mitteleurop√§ische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
